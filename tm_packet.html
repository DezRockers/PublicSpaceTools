<!DOCTYPE html PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html>
<head>

<link rel="stylesheet" href="styles.css">

<script src="generic.js"></script>

<script type="text/javascript">

function DisplayTmFields()
{
	var str = document.getElementById("inputString").value;
	str = trim(str);
	var bytes = new Array();
	var txt = "";
	bytes = str.split(" ");
	for (i = 0; i < bytes.length; i++)
	{
		txt = txt + bytes[i] + "\n";
	}
	//alert(txt);
	
	// check that length of each element is 2 characters (for a byte)
	for (i = 0; i < bytes.length; i++)
	{
		if (bytes[i].length != 2)
		{
			alert("element " + i + " = " + bytes[i] + " needs length 2");
			return;
		}
		// convert each 2 character string to hexadecimal integer
		bytes[i] = parseInt(bytes[i],16) & 0xff;
	}
	TM_packet(bytes);
}

//TM_packet() extracts the TM fields from the Tm packet.
function TM_packet( bytes )
{
	// primary header
	var packetVersionNumber = ( bytes[0] >> 5 ) & 0x7 ;	// should be 0
	var packetType = ( bytes[0] >> 4 ) & 0x1 ;		// this should be 0 for TM (1 for TC)
	var secondaryHeaderFlag = ( bytes[0] >> 3 ) & 0x1 ; 
	var apid = ((bytes[0] & 0x7) << 8) + (bytes[1]) ; 		
	var sequenceFlags  = ( bytes[2] >> 6 ) & 0x3 ;
	var packetSequenceCount = (( bytes[2] & 0x3F )<< 8) + bytes[3] ;
	var packetDataLength = (bytes[4] << 8) + bytes[5];
	var packetStartByte = 6;

	// display the fields
	document.getElementById("packetVersionNumber").value = packetVersionNumber.toString(16).toUpperCase();
	document.getElementById("packetType").value = packetType.toString(16).toUpperCase();
	document.getElementById("secondaryHeaderFlag").value = secondaryHeaderFlag.toString(16).toUpperCase();
	document.getElementById("apid").value = apid.toString(16).toUpperCase();
	document.getElementById("sequenceFlags").value = sequenceFlags.toString(16).toUpperCase();
	document.getElementById("packetSequenceCount").value = packetSequenceCount.toString(16).toUpperCase();
	document.getElementById("packetDataLength").value = packetDataLength.toString(10);

	// secondary header
	var i = 0;
	if (secondaryHeaderFlag == 1)
	{
		var pusVersionNumber = (bytes[6] >> 4) & 0xF;
		var timeRef = (bytes[6] >> 0) & 0xF;
		var serviceType = bytes[7];
		var serviceSubtype = bytes[8];
		packetStartByte = packetStartByte + 3;

		// message type counter if present
		var messageTypeCounter = "";
		for (i = packetStartByte; i < packetStartByte + Number(document.getElementById("msgTypeCntrLength").value); i++)
		{
			messageTypeCounter = messageTypeCounter + bytes[i].toString(16).toUpperCase().padStart(2,'0') + " ";
		}
		packetStartByte = packetStartByte + Number(document.getElementById("msgTypeCntrLength").value);

		// destination id if present
		var destinationId = "";
		for (i = packetStartByte; i < packetStartByte + Number(document.getElementById("destIdLength").value); i++)
		{
			destinationId = destinationId + bytes[i].toString(16).toUpperCase().padStart(2,'0') + " ";
		}
		packetStartByte = packetStartByte + Number(document.getElementById("destIdLength").value);

		// time p-field if present
		var timePfield = "";
		for (i = packetStartByte; i < packetStartByte + Number(document.getElementById("pFieldLength").value); i++)
		{
			timePfield = timePfield + bytes[i].toString(16).toUpperCase().padStart(2,'0') + " ";
		}
		packetStartByte = packetStartByte + Number(document.getElementById("pFieldLength").value);

		// time t-field if present
		var timeTfield = "";
		for (i = packetStartByte; i < packetStartByte + Number(document.getElementById("timeFieldLength").value); i++)
		{
			timeTfield = timeTfield + bytes[i].toString(16).toUpperCase().padStart(2,'0') + " ";
		}
		packetStartByte = packetStartByte + Number(document.getElementById("timeFieldLength").value);

		// spare field if present
		var spare = "";
		for (i = packetStartByte; i < packetStartByte + Number(document.getElementById("spareLength").value); i++)
		{
			spare = spare + bytes[i].toString(16).toUpperCase().padStart(2,'0') + " ";
		}
		packetStartByte = packetStartByte + Number(document.getElementById("spareLength").value);

		// display the fields
		document.getElementById("pusVersionNumber").value = pusVersionNumber.toString(16).toUpperCase();
		document.getElementById("timeRef").value = timeRef.toString(16).toUpperCase();
		document.getElementById("serviceType").value = serviceType.toString(16).toUpperCase();
		document.getElementById("serviceSubtype").value = serviceSubtype.toString(16).toUpperCase();
		document.getElementById("messageTypeCounter").value = messageTypeCounter.toString(16);
		document.getElementById("destinationId").value = destinationId.toString(16).toUpperCase();
		document.getElementById("pField").value = timePfield.toString(16).toUpperCase();
		document.getElementById("timeField").value = timeTfield.toString(16).toUpperCase();
		document.getElementById("spare").value = spare.toString(16).toUpperCase();

	}

	var tmPacket = "";
	for (i = packetStartByte; i < bytes.length-2; i++)
	{
		tmPacket = tmPacket + bytes[i].toString(16).toUpperCase().padStart(2,'0') + " ";
	}
	var pec = bytes[bytes.length-2].toString(16).toUpperCase().padStart(2,'0') + " " + bytes[bytes.length-1].toString(16).toUpperCase().padStart(2,'0');

	// display the fields
	document.getElementById("tmPacket").value = tmPacket;
	document.getElementById("pec").value = pec.toString(16).toUpperCase();

	document.getElementById("totalPacketLength").value = bytes.length;
	document.getElementById("totalHeaderLength").value = packetStartByte;
	document.getElementById("userDataLength").value = bytes.length - packetStartByte - 2;
	document.getElementById("totalTrailerLength").value = 2;

	GenerateReport();
}

function ClearFields()
{
	document.getElementById("getString").reset();
	document.getElementById("primary").reset();
	document.getElementById("secondary").reset();
	document.getElementById("userdata").reset();

	let target = document.getElementById('downloadLink');
	target.style.visibility = "hidden";

	// but reset the defaults
	SetDefaults();
}

// function to display TM packet help message
function DisplayHelp()
{
var txt = "This tool displays the individual fields of the input TM CCSDS Space packet in hexadecimal bytes.\n";
txt = txt + "The information has been taken from ECSS-E-ST-70-41C 15 April 2016 section 7.4.";
alert(txt);
}

function SetDefaults()
{
	document.getElementById("msgTypeCntrLength").value = 2;
	document.getElementById("destIdLength").value = 2;
	document.getElementById("pFieldLength").value = 1;
	document.getElementById("timeFieldLength").value = 7;
	document.getElementById("spareLength").value = 0;
}

// Generate the file download URL and assign it to the link
function GenerateReport()
{
	var report = "TM Packet Report created on : " + new Date() + "\n";
	report = report + "Input TM Packet (hex bytes) : " + document.getElementById("inputString").value + "\n";
	report = report + "TM Packet message type counter length (input) : " + document.getElementById("msgTypeCntrLength").value + "\n";
	report = report + "TM Packet destination Id length (input) : " + document.getElementById("destIdLength").value + "\n";
	report = report + "TM Packet P-field length (input) : " + document.getElementById("pFieldLength").value + "\n";
	report = report + "TM Packet T-field length (input) : " + document.getElementById("timeFieldLength").value + "\n";
	report = report + "TM Packet Spare field length (input) : " + document.getElementById("spareLength").value + "\n";

	report = report + "\nTM Packet Primary Header Fields : \n";
	report = report + "TM Packet Version Number : " + document.getElementById("packetVersionNumber").value + "\n";
	report = report + "TM Packet Type (0 for TM) : " + document.getElementById("packetType").value + "\n";
	report = report + "TM Packet Secondary Header Flag : " + document.getElementById("secondaryHeaderFlag").value + "\n";
	report = report + "TM Packet Application Process ID (hex) : " + document.getElementById("apid").value + "\n";
	report = report + "TM Packet Sequence Flags : " + document.getElementById("sequenceFlags").value + "\n";
	report = report + "TM Packet Sequence Count (hex) : " + document.getElementById("packetSequenceCount").value + "\n";
	report = report + "TM Packet Data Length - 7 (decimal) : " + document.getElementById("packetDataLength").value + "\n";

	report = report + "\nTM Packet Secondary Header Fields : \n";
	report = report + "TM Packet PUS Version Number : " + document.getElementById("pusVersionNumber").value + "\n";
	report = report + "TM Packet Time Reference (hex) : " + document.getElementById("timeRef").value + "\n";
	report = report + "TM Packet Service Type ID (hex) : " + document.getElementById("serviceType").value + "\n";
	report = report + "TM Packet Service Subtype ID (hex) : " + document.getElementById("serviceSubtype").value + "\n";
	report = report + "TM Packet Message Type Counter (hex) : " + document.getElementById("messageTypeCounter").value + "\n";
	report = report + "TM Packet Destination ID (hex) : " + document.getElementById("destinationId").value + "\n";
	report = report + "TM Packet Time P-Field (hex) : " + document.getElementById("pField").value + "\n";
	report = report + "TM Packet Time T-Field (hex) : " + document.getElementById("timeField").value + "\n";
	report = report + "TM Packet Spare Field (hex) : " + document.getElementById("spare").value + "\n";

	report = report + "\nTM Packet Content Fields : \n";
	report = report + "TM Packet Data (hex) : " + document.getElementById("tmPacket").value + "\n";
	report = report + "TM Packet Error Control Field (hex) : " + document.getElementById("pec").value + "\n";

	report = report + "\nTM Packet Other Useful Data : \n";
	report = report + "TM Packet Total Packet Length (decimal) : " + document.getElementById("totalPacketLength").value + "\n";
	report = report + "TM Packet Total Header Length (decimal) : " + document.getElementById("totalHeaderLength").value + "\n";
	report = report + "TM Packet Total User Data Length (decimal) : " + document.getElementById("userDataLength").value + "\n";
	report = report + "TM Packet Total Trailer Length (decimal) : " + document.getElementById("totalTrailerLength").value + "\n";

	DownloadFile('downloadLink', report);
}

// insert an example TM packet for testing purposes
function ExampleTmPacket()
{
	ClearFields();
	
	// the following is an example ELSA-d Tm packet 
	document.getElementById("inputString").value = "08 C1 C2 36 03 13 10 03 19 2E 00 00 04 59 F7 BF 04 00 00 00 04 5A 57 EA C4 9F F0 33 7F B9 02 00 2A 61 C0 00 B4 00 00 00 18 99 91 33 7B B9 00 00 F5 80 C0 80 00 00 00 00 60 80 00 33 7B B9 02 00 C2 72 C0 00 00 00 00 00 E0 80 00 33 7B B9 00 00 41 1A C0 00 0E 00 00 00 05 00 00 00 00 00 20 A1 00 00 3A 00 00 06 00 00 65 05 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 12 00 00 00 00 F0 00 00 00 00 00 00 00 FF 00 00 04 00 00 00 00 00 00 00 00 00 00 7E 00 00 00 BA 42 8E 00 02 00 02 00 38 00 24 00 00 00 00 00 00 00 B3 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 04 61 FF FF FF FF 00 01 00 00 FF FE FF FF 00 05 16 00 F0 00 F0 03 F3 FF 0F 00 FF FF FF FF FF FF FF FF 3F 33 33 FF 4F 4F 33 43 F4 F3 33 33 33 33 34 00 40 8D 00 00 00 00 00 00 00 00 00 EC 00 00 00 00 08 F9 00 00 00 00 01 08 C4 00 01 14 C4 00 00 19 3F 00 00 00 00 06 00 00 80 00 2E 00 00 4E 20 00 00 00 00 00 00 00 06 BE 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1D 00 1D 00 1D 00 1D 00 1D 00 1D 00 1D 00 1D 00 00 00 00 00 88 A0 88 A0 88 A0 88 A0 37 8C 00 59 02 00 00 00 00 F0 2C 80 00 01 00 00 00 13 3D 00 01 00 00 00 0E 01 00 00 00 00 00 00 F5 46 00 D0 00 DE 02 A3 01 A2 10 04 08 33 0B B8 0B 35 00 00 00 00 00 00 02 1C 00 00 00 00 00 C0 3F 00 00 50 00 50 00 50 00 50 FD 04 00 68 00 00 68 00 00 00 00 19 19 00 00 00 00 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 50 00 00 00 00 00 00 00 00 00 00 00 00 00 F8 3E 3E 3E 3E 00 00 00 00 00 00 FF FE CC FF FF 05 FF FF 29 7F 28 15 00 00 FA BF 44 4F 02 9F 00 55 00 00 00 00 00 00 00 00 00 00 00 00 00 00 A8 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 A0 5B 79 1D DD 9B DE 06 E2 00 00 00 00 77 80 00 00 00 00 00 00 00 2D 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 03 F8 FE 00 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FF FF 10 00 00 F8 3E 3E 3E 3E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FA 72 45 CC FD E5 00 55 00 00 00 00 00 00 00 00 00 00 00 00 00 00 A8 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 EC F0 20 00 00 00 00 00 00 00 00 00 00 15 E0 E0 FF FF 00 00 FF 00 FF FF FC 00 00 00 00 FF FF FF FF FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 FC 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 6D 90";
	
	AddSpaces();
}



</script>
</head>

<body onload="SetDefaults()">
<H3 style="color:Silver;">TM Packet</H3>
<p style="color:Silver;">
This tool displays the individual fields of the input TM CCSDS packet in hexadecimal bytes.
</p>

<table border="1" borderColor="Silver">
<tr id="tr1">

<td style="vertical-align:top;">
<form id = "getString" style="color:Silver;">
Input the TM string as either non-delimited hexadecimal bytes and then click 'Add Spaces to TM String' button or space delimited hexadecimal bytes and then click 'Display TM Fields' button<br />
<input type="text" id="inputString" maxLength=4000 size=200/><br />
<input type="text" id="msgTypeCntrLength" maxLength=10 size=10/>Input the length of the message type counter field in bytes. The CCSDS value for this is 2 bytes but some missions omit this field.<br />
<input type="text" id="destIdLength" maxLength=10 size=10/>Input the length of the destination ID field in bytes. The CCSDS value for this is 2 bytes but some missions omit this field.<br />
<input type="text" id="pFieldLength" maxLength=10 size=10/>Input the length of the time P-field in bytes. This is mission specific and is usually 0 or 1 byte long. Default is 1.<br />
<input type="text" id="timeFieldLength" maxLength=10 size=10/>Input the length of the time T-field in bytes. This is mission specific and is usually several bytes long. Default is 7.<br />
<input type="text" id="spareLength" maxLength=10 size=10/>Input the length of the spare field in bytes. This is mission specific. Default is 0.
</form>

<button class="button button1" onclick="AddSpaces()">Add Spaces to TM String</button>
<button class="button button1" onclick="DisplayTmFields()">Display TM Fields</button>
<button class="button button1" onclick="ClearFields()">Clear Fields</button>
<button class="button button1" onclick="ExampleTmPacket()">Example TM Packet</button>
<button class="button button1" onclick="DisplayHelp()">Help</button>
<!-- Download link - defaults to # which means clicking it does nothing as no file download link has been assigned (yet) -->
<!-- Note the use of the download attribute! It tells the browser to download the file, and what the default file name should be -->
<a id="downloadLink" href="#" download="TmPacketReport.txt" style="visibility:hidden">Download Report</a>

</td>
</tr>
</table>

<table border="1" borderColor="Silver">
<tr id="tr1">

<td style="vertical-align:top;">
<form id = "primary" style="color:Silver;">
TM Primary Header Fields<br />
<input type="text" id="packetVersionNumber" maxLength=10 size=10/>Packet Version Number<br />
<input type="text" id="packetType" maxLength=10 size=10/>Packet Type (0 for TM)<br />
<input type="text" id="secondaryHeaderFlag" maxLength=10 size=10/>Secondary Header Flag<br />
<input type="text" id="apid" maxLength=10 size=10/>Application Process ID (hex)<br />
<input type="text" id="sequenceFlags" maxLength=10 size=10/>Sequence Flags<br />
<input type="text" id="packetSequenceCount" maxLength=10 size=10/>Packet Sequence Count (hex)<br />
<input type="text" id="packetDataLength" maxLength=10 size=10/>Packet Data Length - 7 (decimal)<br />
</form>
</td>

<td style="vertical-align:top;">
<form id = "secondary" style="color:Silver;">
TM Secondary Header Fields<br />
<input type="text" id="pusVersionNumber" maxLength=10 size=10/>TM Packet PUS Version Number<br />
<input type="text" id="timeRef" maxLength=10 size=10/>Time Reference (hex)<br />
<input type="text" id="serviceType" maxLength=10 size=10/>Service Type ID (hex)<br />
<input type="text" id="serviceSubtype" maxLength=10 size=10/>Service Subtype ID (hex)<br />
<input type="text" id="messageTypeCounter" maxLength=10 size=10/>Message Type Counter (hex)<br />
<input type="text" id="destinationId" maxLength=10 size=10/>Destination ID (hex)<br />
<input type="text" id="pField" maxLength=10 size=10/>Time P-Field (hex)<br />
<input type="text" id="timeField" maxLength=20 size=20/>Time T-Field (hex)<br />
<input type="text" id="spare" maxLength=10 size=10/>Spare Field (hex)<br />
</form>
</td>

<td style="vertical-align:top;">
<form id = "userdata" style="color:Silver;">
TM Packet Contents<br />
<input type="text" id="tmPacket" maxLength=4000 size=107/>TM Packet Data (hex)<br />
<input type="text" id="pec" maxLength=10 size=10/>Packet Error Control Field (hex)<br /><br />

Other Useful Data<br />
<input type="text" id="totalPacketLength" maxLength=10 size=10/>Total Packet Length (decimal)<br />
<input type="text" id="totalHeaderLength" maxLength=10 size=10/>Total Header Length (decimal)<br />
<input type="text" id="userDataLength" maxLength=10 size=10/>Total User Data Length (decimal)<br />
<input type="text" id="totalTrailerLength" maxLength=10 size=10/>Total Trailer Length (decimal)
</form>
</td>

</tr>
</table>

</body>
</html>
